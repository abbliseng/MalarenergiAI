<html>

<body>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <div class="header">
        <img class="logo" src="static/mälarenergi.png">
        <h1>Energispåkärringen</h1>
    </div>

    <div class="popupContainer" id="test" onclick="deletePopup(id)">
        <i class="fa fa-warning"> </i>
        Warning: Write in an hour and date
    </div>
    <div class="popupContainer" id="negative_Warning" onclick="deletePopup(id)">
        <i class="fa fa-warning"> </i>
        Fel: Ange ett kommande datum, inte ett passerat
    </div>
    <div class="popupContainer" id="ToMuch_Warning" onclick="deletePopup(id)">
        <i class="fa fa-warning"> </i>
        Fel: Ange ett datum inom de kommande 10 dagarna
    </div>

    <div class="main_container">



        <div id="container1">
            <div class="input_container">
                <p class="heading">Inmatning av värden</p>
                <div class="inputs" id="inputs">
                    <input type="date" id="date" name="date" placeholder="Datum">
                    <input type="text" id="timme" name="timme" placeholder="Timme">
                    <input type="text" id="temperature" name="temperature" placeholder="Temperatur">
                    <button onClick="predict()">Prediktera</button>
                </div>
                <div id="loader" class="loader" style="display: none;"></div>
                <!-- <p>Inmatad temperatur: <span id="temperatureValue"></span></p> -->
            </div>
        </div>



        <p id="pp"></p>
        <div class="container2">
            <div class="table_container">
                <p class="heading">Prognostiserade värden för kommande 24 timmar</p>
                <!-- <p class="heading">Prognostiserade värden för timme 0-12</p> -->
                <div style="margin-bottom: 20px;" id="table1">
                </div>
                <!-- <p class="heading">Prognostiserade värden för timme 13-24</p> -->
                <div id="table2">
                </div>
            </div>
        </div>

        <div id="container3">
            <div class="img_container">
                <div>
                    <p class="heading">Graf över prognos</p>
                    <img class="centerImage" id="graph" src="/static/graf.jpg" alt="graf">
                </div>

            </div>
        </div>

        <!-- <div class="container2">
            <div class="training_container">
                <div>
                    <p class="heading">Imatning av träningsdata och träning av model</p>
                    <p>Excel-fil med följande format [år, månad, dag, timme, temperatur, vindhastighet]</p>
                    <div class="inputs">
                        <input type="file" name="training_data" id="training_data" accept=".csv">
                        <button onClick="train()">Träna</button>
                    </div>
                </div>
            </div>
        </div> -->

    </div>

    <!-- NYTT TABLE -->



    <div class="bottom">
        <!-- <h1>Info</h1> -->
        <p>Skriv in datum, timme och en temperatur för att få en förutspådd effekt för den timmen.
            Om det inte skrivs in något datum så visas temperaturen för de nästa 24 timmarna i en graf.</p>
    </div>
</body>

</html>

<script>
    // function train() {
    //     var training_data = document.getElementById("training_data").value
    //     console.log(training_data)
    //     $('input[type=file]').change(function () {
    //         console.log(this.files[0].mozFullPath);
    //     });
    // }

    function calculateDate () {

        var month = new Date().getUTCMonth() + 1 //months from 1-12
        var day = new Date().getUTCDate()
        var year = new Date().getUTCFullYear()

        //skriver ut nuvarande datum vid 'Date: ' (ska tas bort senare)
        // document.getElementById("Date").innerHTML = year + "-" + month + "-" + day;

        //Tar in och formaterar inskrivet datum
        In_day = document.getElementById("date").value.replaceAll(/-/gi, '/')

        //dela upp år, månad och dag för att kunna mata in i date2
        // document.getElementById("date").innerHTML = In_day;

        //definerar datum som ska beräknas
        var date1 = new Date(year + "/" + month + "/" + day) // Datum idag
        var date2 = new Date(In_day) // Inskrivet datum 


        // beräknar skillnaden mellan date1 och date2
        var Difference_In_Time = date2.getTime() - date1.getTime()

        var Difference_In_Days = Difference_In_Time / (1000 * 3600 * 24)

        //skriver ut skillnaden mellan nuvarande datum och date2
        // document.getElementById("Difference").innerHTML = Difference_In_Days;

        if (Difference_In_Days < 0) {
            var poppy = document.getElementById("negative_Warning")
            poppy.style.display = "block"
        }
        else if (Difference_In_Days > 10) {
            var poppy = document.getElementById("ToMuch_Warning")
            poppy.style.display = "block"
        };
    }

    //NY PREDICT!




    function predict () {
        // var inp = document.getElementById("inputs")
        // var load = document.getElementById("loader")
        // inp.style.display = "none"
        // load.style.display = "block"

        //börja ladda
        calculateDate()
        var date = document.getElementById("date").value
        var hour = document.getElementById("timme").value
        var temp = document.getElementById("temperature").value

        // document.getElementById("loading_container").style.display = "flex"

        if (!date) {
            // If no date is entered get tomorrows date.
            var d = new Date()
            d.setDate(d.getDate() + 1)
            var day = d.getDate()
            var month = d.getMonth() + 1
            if (day < 10) { day = 0 + day.toString() }
            if (month < 10) { month = 0 + month.toString() }
            date = d.getFullYear() + "-" + month + "-" + day
        }
        if (date && !hour && !temp) {
            var inp = document.getElementById("inputs")
            var load = document.getElementById("loader")
            inp.style.display = "none"
            load.style.display = "block"

            fetch('/predict/' + date)
                .then(function (response) {
                    return response.json()
                }).then(function (text) {
                    var predictions = text.prediction_value
                    var temps = text.temperatures
                    var hours = text.hours
                    var img_path = text.img_path
                    predictions.forEach((p, i) => predictions[i] = p.toFixed(2))
                    temps.forEach((t, i) => temps[i] = t.toFixed(0))
                    hours.forEach((x, i) => hours[i] = parseInt(x, 10))
                    document.getElementById("graph").src = img_path + '?' + new Date().getTime() // adding query to force image to reload
                    updateTable(predictions, temps, hours)
                    inp.style.display = "block"
                    load.style.display = "none"
                })

        }
        else if (date && hour && !temp) {
            fetch('/predict/' + date + '/' + hour)
                .then(function (response) {
                    return response.json()
                }).then(function (text) {
                    if (text.status == 200 ? document.getElementById("pp").innerHTML = parseFloat(text.prediction_value).toFixed(2) + ' MWh' : document.getElementById("pp").innerHTML = "ERROR");
                    inp.style.display = "block"
                    load.style.display = "none"
                })
        }
        else if (date && hour && temp) {
            // Temp has been entered
            fetch('/predict/' + date + '/' + hour + '/' + temp)
                .then(function (response) {
                    return response.json()
                }).then(function (text) {
                    document.getElementById("pp").innerHTML = parseFloat(text.prediction_value).toFixed(2) + ' MWh'
                    inp.style.display = "block"
                    load.style.display = "none"
                })
        }
        else if (!hour && temp) {
            var poppy = document.getElementById("test")
            poppy.style.display = "block"
        }

        // document.getElementById("loading_container").style.display = "none"
        document.getElementById("container2").style.display = "flex"
        document.getElementById("container3").style.display = "flex"

    }

    function updateTable (predictions, temps, hours) {
        // var outputHTML = ""
        // var tempData = temps
        // var powerData = predictions
        // var hourData = hours
        // var avgTemp = "15"
        // var avgPower = "18"

        // outputHTML += "<table>"


        // outputHTML += "<tr>"
        // outputHTML += "<th>" + "Timme" + "</th>"
        // for (var i = 0; i < hourData.length; i++) {
        //     outputHTML += "<td>" + hourData[i] + "</td>"
        // }
        // // outputHTML += "<th>" + hourData.length() + "</th>"
        // outputHTML += "</tr>"
        // outputHTML += "<tr>"
        // outputHTML += "<th>" + "Temperatur (°C)" + "</th>"
        // for (var i = 0; i < tempData.length; i++) {
        //     outputHTML += "<td>" + tempData[i] + "</td>"
        // }
        // outputHTML += "<th>" + avgTemp + "</th>"
        // outputHTML += "</tr>"
        // outputHTML += "<tr>"
        // outputHTML += "<th>" + "Effekt (MW)" + "</th>"
        // for (var i = 0; i < powerData.length; i++) {
        //     outputHTML += "<td>" + powerData[i] + "</td>"
        // }
        // outputHTML += "<th>" + avgPower + "</th>"
        // outputHTML += "</tr>"
        // outputHTML += "</table>"


        // document.getElementById("table").innerHTML = outputHTML

        //VERTIKAL TABLE
        //
        //
        // var outputHTML = ""
        // var tempData = temps
        // var powerData = predictions
        // var hourData = hours
        // var avgTemp = "15"
        // var avgPower = "18"

        // outputHTML += "<table>"

        // outputHTML += "<tr><th>Timme</th><th>Effekt</th><th>Temperatur</th></tr>"

        // for (var i = 0; i < hourData.length; i++) {
        //     outputHTML += "<tr><td>" + hourData[i] + "</td><td>" + tempData[i] + "</td><td>" + powerData[i] + "</td><td>" + "</tr>"
        // }
        // outputHTML += "</table>"

        // document.getElementById("table").innerHTML = outputHTML
        //
        //
        //

        var outputHTML1 = ""
        var outputHTML2 = ""
        var tempData = temps
        var powerData = predictions
        var hourData = hours
        var sumTemp = 0
        var sumPower = 0

        for (i = 0; i < tempData.length; i++) {
            sumTemp += parseInt(tempData[i])
            sumPower += parseFloat(powerData[i])
        }

        console.log(sumTemp)
        console.log(sumPower)

        console.log(typeof (sumTemp))
        console.log(typeof (sumPower))


        var avgTemp = (sumTemp / tempData.length).toFixed(1)
        var avgPower = (sumPower / tempData.length).toFixed(2)

        console.log(avgTemp)
        console.log(avgPower)

        console.log(typeof (avgTemp))
        console.log(typeof (avgPower))

        outputHTML1 += "<table><tr>"
        outputHTML1 += "<th>" + "Timme (h)" + "</th>"
        for (var i = 0; i < 13; i++) {
            outputHTML1 += "<td>" + hourData[i] + ":00" + "</td>"
        }
        outputHTML1 += "</tr>"
        outputHTML1 += "<tr>"
        outputHTML1 += "<th>" + "Temperatur (°C)" + "</th>"
        for (var i = 0; i < 13; i++) {
            outputHTML1 += "<td>" + tempData[i] + "</td>"
        }
        outputHTML1 += "</tr>"
        outputHTML1 += "<tr>"
        outputHTML1 += "<th>" + "Effekt (MW)" + "</th>"
        for (var i = 0; i < 13; i++) {
            outputHTML1 += "<td>" + powerData[i] + "</td>"
        }
        outputHTML1 += "</tr></table>"

        document.getElementById("table1").innerHTML = outputHTML1

        //DEL TVÅ AV TABELLEN

        outputHTML2 += "<table><tr>"

        outputHTML2 += "<th>" + "Timme (h)" + "</th>"
        for (var i = 13; i < 24; i++) {
            outputHTML2 += "<td>" + hourData[i] + ":00" + "</td>"
        }
        outputHTML2 += "<th>" + "Medel" + "</th>"
        outputHTML2 += "</tr><tr>"
        outputHTML2 += "<th>" + "Temperatur (°C)" + "</th>"
        for (var i = 13; i < 24; i++) {
            outputHTML2 += "<td>" + tempData[i] + "</td>"
        }
        outputHTML2 += "<th>" + avgTemp + "</th>"
        outputHTML2 += "</tr><tr>"
        outputHTML2 += "<th>" + "Effekt (MW)" + "</th>"
        for (var i = 13; i < 24; i++) {
            outputHTML2 += "<td>" + powerData[i] + "</td>"
        }
        outputHTML2 += "<th>" + avgPower + "</th>"
        outputHTML2 += "</tr></table>"

        document.getElementById("table2").innerHTML = outputHTML2
    }

    function deletePopup (id) {
        document.getElementById(id).style.display = "none"
    }

</script>



<style>
    h1 {
        margin: 15px;
        text-align: center;
    }

    label {
        margin-left: 20px;
    }

    input {
        margin-left: 10px;
        margin-right: 10px;
        padding: 10px;
        max-width: 130px;
        border-color: #a7a7a7;
        border-radius: 10px;
    }

    button {
        margin-left: 10px;
        margin-right: 10px;
        padding: 10px;
        border-color: #a7a7a7;
        border-radius: 10px;
        background-color: rgb(91, 90, 90);
        color: white;
    }

    .header {
        padding: 20px;
        text-align: center;
        background: #091540;
        color: white;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .bottom {
        padding: 20px;
        text-align: center;
        background: #091540;
        color: white;
        font-size: 20px;
    }

    .heading {
        font-size: 25px;
        text-align: center;
    }

    body {
        margin: 0px;
        margin: 0;
        background-color: #EEE;
        font-family: "Open Sans", sans-serif;
        box-sizing: border-box;
        cursor: default;
        user-select: none;
    }

    .main_container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #container1 {
        background-color: #CAE6E4;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    #container2 {
        background-color: #D9F8F6;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    #container3 {
        background-color: rgb(231, 231, 231);
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .input_container {
        margin-top: 150px;
        margin-bottom: 150px;
        display: block;
        align-items: center;
        width: auto;
    }

    .training_container {
        margin-top: 150px;
        margin-bottom: 150px;
        display: block;
        align-items: center;
        width: auto;
    }

    .inputs {
        display: flex;
        margin-bottom: 10px;
    }

    .img_container {
        /* background-color: black; */
        display: flex;
        justify-content: center;
        margin-top: 150px;
        margin-bottom: 150px;
    }

    .centerImage {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .table_container {
        margin-top: 150px;
        margin-bottom: 150px;
    }

    .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite;
        /* Safari */
        animation: spin 2s linear infinite;
        /* Safari */
        left: 50%;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    img {
        border-radius: 25px;
        width: 80%;
    }

    table,
    th,
    td {
        border: 1px solid;
        padding: 10px;
        text-align: center;
    }

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    th {
        text-align: left;
        background-color: #bebcbc;
    }

    .logo {
        display: grid;
        float: left;
        justify-content: center;
        align-items: top;
        margin-left: 35px;
        position: absolute;
        left: 0px;
        height: 310px;
    }

    .popupContainer {
        position: absolute;
        top: 20%;
        background-color: #FEEFB3;
        color: #9F6000;
        width: 100%;
        padding: 16px;
        display: none;
    }
</style>