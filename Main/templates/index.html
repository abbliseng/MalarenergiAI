<html>

<body>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <div class="header">
        <img class="logo" src="static/mälarenergi.png">
        <h1>Energispåkärringen</h1>
    </div>

    <div class="popupContainer" id="test" onclick="deletePopup(id)">
         <i class="fa fa-warning" > </i>
         Warning: Write in an hour and date
    </div>
    <div class="popupContainer" id="negative_Warning" onclick="deletePopup(id)">
        <i class="fa fa-warning" > </i>
        Fel: Ange ett kommande datum, inte ett passerat
   </div>
   <div class="popupContainer" id="ToMuch_Warning" onclick="deletePopup(id)">
        <i class="fa fa-warning" > </i>
        Fel: Ange ett datum inom de kommande 10 dagarna
    </div>

    <div class="main_container">

        <div class="container1">
            <div class="input_container">
                <p class="heading">Inmatning av värden</p>
                <div class="inputs" id="inputs">
                    <input type="date" id="date" name="date" placeholder="Datum">
                    <input type="text" id="timme" name="timme" placeholder="Timme">
                    <input type="text" id="temperature" name="temperature" placeholder="Temperatur">
                    <button onClick="predict()">Prediktera</button>
                </div>
                <div id="loader" class="loader" style="display: none;"></div>
                <!-- <p>Inmatad temperatur: <span id="temperatureValue"></span></p> -->
            </div>
        </div>

        

        <p id="pp"></p>
        <div class="container2">
            <div class="table_container">
                <p class="heading">Prognostierade värden för kommande 24 timmar</p>
                <div id="table">
                </div>
            </div>
        </div>

        <div class="container1">
            <div class="img_container">
                <div>
                    <p class="heading">Graf över kommande värden</p>
                    <img id="graph" src="/static/graf.jpg" alt="graf">
                </div>

            </div>
        </div>

        <!-- <div class="container2">
            <div class="training_container">
                <div>
                    <p class="heading">Imatning av träningsdata och träning av model</p>
                    <p>Excel-fil med följande format [år, månad, dag, timme, temperatur, vindhastighet]</p>
                    <div class="inputs">
                        <input type="file" name="training_data" id="training_data" accept=".csv">
                        <button onClick="train()">Träna</button>
                    </div>
                </div>
            </div>
        </div> -->

    </div>

    <div class="bottom">
        <!-- <h1>Info</h1> -->
        <p>Skriv in datum, timme och en temperatur för att få en förutspådd effekt för den timmen.
            Om det inte skrivs in något datum så visas temperaturen för de nästa 24 timmarna i en graf.</p>
    </div>
</body>

</html>

<script>
    // function train() {
    //     var training_data = document.getElementById("training_data").value
    //     console.log(training_data)
    //     $('input[type=file]').change(function () {
    //         console.log(this.files[0].mozFullPath);
    //     });
    // }

    function calculateDate () {

        var month = new Date().getUTCMonth() + 1; //months from 1-12
        var day = new Date().getUTCDate();
        var year = new Date().getUTCFullYear();

        //skriver ut nuvarande datum vid 'Date: ' (ska tas bort senare)
        // document.getElementById("Date").innerHTML = year + "-" + month + "-" + day;

        //Tar in och formaterar inskrivet datum
        In_day = document.getElementById("date").value.replaceAll(/-/gi,'/');

        //dela upp år, månad och dag för att kunna mata in i date2
        // document.getElementById("date").innerHTML = In_day;

        //definerar datum som ska beräknas
        var date1 = new Date(year + "/" + month + "/" + day); // Datum idag
        var date2 = new Date(In_day); // Inskrivet datum 


        // beräknar skillnaden mellan date1 och date2
        var Difference_In_Time = date2.getTime() - date1.getTime();

        var Difference_In_Days = Difference_In_Time / (1000 * 3600 * 24);

        //skriver ut skillnaden mellan nuvarande datum och date2
        // document.getElementById("Difference").innerHTML = Difference_In_Days;

        if (Difference_In_Days < 0) {
            var poppy = document.getElementById("negative_Warning");
            poppy.style.display = "block";
        }
        else if (Difference_In_Days > 10) {
            var poppy = document.getElementById("ToMuch_Warning");
            poppy.style.display = "block";
        };
    }

    function predict() {
        var inp = document.getElementById("inputs");
        var load = document.getElementById("loader");
        inp.style.display = "none";
        load.style.display = "block";
 
        //börja ladda
        calculateDate()
        var date = document.getElementById("date").value
        var hour = document.getElementById("timme").value
        var temp = document.getElementById("temperature").value
        if (!date) {
            // If no date is entered get tomorrows date.
            var d = new Date();
            d.setDate(d.getDate()+1)
            var day = d.getDate()
            var month = d.getMonth()+1
            if (day < 10) {day = 0+day.toString()}
            if (month < 10) {month = 0+month.toString()}
            date = d.getFullYear()  + "-" + month + "-" + day
        }
        if (date && !hour && !temp) {
            fetch('/predict/'+date)
            .then(function (response) {
                return response.json();
            }).then(function (text) {
                var predictions = text.prediction_value
                var temps = text.temperatures
                var hours = text.hours
                var img_path = text.img_path
                predictions.forEach((p,i) => predictions[i] = p.toFixed(2))
                temps.forEach((t,i) => temps[i] = t.toFixed(0))
                hours.forEach((x,i) => hours[i] = parseInt(x, 10))
                document.getElementById("graph").src = img_path +'?'+ new Date().getTime() // adding query to force image to reload
                updateTable(predictions, temps, hours)
                inp.style.display = "block";
                load.style.display = "none";
            }); 

        }
        else if (date && hour && !temp) {
            fetch('/predict/'+date+'/'+hour)
            .then(function (response) {
                return response.json();
            }).then(function (text) {
                if (text.status == 200 ? document.getElementById("pp").innerHTML = parseFloat(text.prediction_value).toFixed(2) + ' MWh' : document.getElementById("pp").innerHTML = "ERROR");
                inp.style.display = "block";
                load.style.display = "none";
            });
        }
        else if (date && hour && temp) {
            // Temp has been entered
            fetch('/predict/'+date+'/'+hour+'/'+temp)
            .then(function (response) {
                return response.json();
            }).then(function (text) {
                document.getElementById("pp").innerHTML = parseFloat(text.prediction_value).toFixed(2) + ' MWh'
                inp.style.display = "block";
                load.style.display = "none";
            });
        }
        else if(!hour && temp)
        {
            var poppy = document.getElementById("test");
            poppy.style.display = "block";
        }
        
    }

    function updateTable(predictions, temps, hours) {
        var outputHTML = ""
        var tempData = temps
        var powerData = predictions
        var hourData = hours
        var avgTemp = "15"
        var avgPower = "18"

        outputHTML += "<table>"
        
        
        outputHTML += "<tr>"
        outputHTML += "<th>" + "Timme" + "</th>"
        for (var i = 0; i < hourData.length; i++) {
            outputHTML += "<td>" + hourData[i] + "</td>"
        }
        // outputHTML += "<th>" + hourData.length() + "</th>"
        outputHTML += "</tr>"
        outputHTML += "<tr>"
        outputHTML += "<th>" + "Temperatur (°C)" + "</th>"
        for (var i = 0; i < tempData.length; i++) {
            outputHTML += "<td>" + tempData[i] + "</td>"
        }
        outputHTML += "<th>" + avgTemp + "</th>"
        outputHTML += "</tr>"
        outputHTML += "<tr>"
        outputHTML += "<th>" + "Effekt (MW)" + "</th>"
        for (var i = 0; i < powerData.length; i++) {
            outputHTML += "<td>" + powerData[i] + "</td>"
        }
        outputHTML += "<th>" + avgPower + "</th>"
        outputHTML += "</tr>"
        outputHTML += "</table>"


        document.getElementById("table").innerHTML = outputHTML;
    }

    function deletePopup(id)
    {
        document.getElementById(id).style.display = "none";
    }

    var outputHTML = ""
    var tempData = ["12", "22", "15", "12", "23", "11", "24", "19", "17"]
    var powerData = ["122", "212", "125", "132", "253", "111", "254", "119", "127"]
    var avgTemp = "15"
    var avgPower = "18"

    outputHTML += "<table>"
    outputHTML += "<tr>"
    outputHTML += "<th>" + "Temperatur (°C)" + "</th>"
    for (var i = 0; i < tempData.length; i++) {
        outputHTML += "<td>" + tempData[i] + "</td>"
    }
    outputHTML += "<th>" + avgTemp + "</th>"
    outputHTML += "</tr>"
    outputHTML += "<tr>"
    outputHTML += "<th>" + "Effekt (MW)" + "</th>"
    for (var i = 0; i < powerData.length; i++) {
        outputHTML += "<td>" + powerData[i] + "</td>"
    }
    outputHTML += "<th>" + avgPower + "</th>"
    outputHTML += "</tr>"
    outputHTML += "</table>"


    document.getElementById("table").innerHTML = outputHTML;



</script>



<style>
    h1 {
        margin: 15px;
        text-align: center;
    }

    label {
        margin-left: 20px;
    }

    input {
        margin-left: 10px;
        margin-right: 10px;
        padding: 10px;
        max-width: 130px;
        border-color: #a7a7a7;
        border-radius: 10px;
    }

    button {
        margin-left: 10px;
        margin-right: 10px;
        padding: 10px;
        border-color: #a7a7a7;
        border-radius: 10px;
        background-color: rgb(91, 90, 90);
        color: white;
    }

    .header {
        padding: 20px;
        text-align: center;
        background: #091540;
        color: white;
        font-size: 20px;
        display:flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .bottom {
        padding: 20px;
        text-align: center;
        background: #091540;
        color: white;
        font-size: 20px;
    }

    .heading {
        font-size: 25px;
        text-align: center;
    }

    body {
        margin: 0px;
        margin: 0;
        background-color: #EEE;
        font-family: "Open Sans", sans-serif;
        box-sizing: border-box;
        cursor: default;
        user-select: none;
    }

    .main_container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .container1 {
        background-color: #CAE6E4;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .container2 {
        background-color: #D9F8F6;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .input_container {
        margin-top: 150px;
        margin-bottom: 150px;
        display: block;
        align-items: center;
        width: auto;
    }

    .training_container {
        margin-top: 150px;
        margin-bottom: 150px;
        display: block;
        align-items: center;
        width: auto;
    }

    .inputs {
        display: flex;
        margin-bottom: 10px;
    }

    .img_container {
        /* background-color: black; */
        display: flex;
        justify-content: center;
        margin-top: 150px;
        margin-bottom: 150px;
        ;
    }

    .table_container {
        margin-top: 150px;
        margin-bottom: 150px;
    }

    .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite; /* Safari */
        left: 50%;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    img {
        border-radius: 25px;
        max-width: 50%;
        max-height: 50%;
    }

    table,
    th,
    td {
        border: 1px solid;
        padding: 10px;
        text-align: center;
    }

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    th {
        text-align: left;
        background-color: #bebcbc;
    }

    .logo {
        display: grid;
        float: left;
        justify-content: center;
        align-items: top;
        margin-left: 35px;
        position: absolute; 
        left: 0px; 
        height: 310px;
    }
    
    .popupContainer {
        position: absolute;
        top: 20%;
        background-color: #FEEFB3;
        color: #9F6000;
        width: 100%;
        padding: 16px;
        display: none;
    }
</style>